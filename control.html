<!DOCTYPE html>

<html lang="de">

<head>
    <meta charset="UTF-8">
    <title></title>

    <link href="control.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400" rel="stylesheet"/>
</head>

<body>
<template id="control-template">
    <div class="cell">
        <span class="pre-icon material-symbols-outlined icon"></span>

        <img alt=""
             class="preview-img"
             src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAEElEQVR42mP8z/C/HwAFAAL/AV2zNgAAAABJRU5ErkJggg=="/>

        <button class="iconBtn backBtn" disabled>
            <span class="material-symbols-outlined">arrow_back</span>
        </button>
        <button class="iconBtn forwardBtn" disabled>
            <span class="material-symbols-outlined">arrow_forward</span>
        </button>

        <input class="url" onkeydown="" placeholder="">

        <button class="iconBtn navigateBtn">
            <span class="material-symbols-outlined">subdirectory_arrow_right</span>
        </button>

        <button class="iconBtn screenShareBtn">
            <span class="material-symbols-outlined">screen_share</span>
        </button>

        <button class="iconBtn priorityBtn">
            <span class="material-symbols-outlined">dock_to_right</span>
        </button>
        <button class="iconBtn fullscreenBtn">
            <span class="material-symbols-outlined">fullscreen</span>
            <span class="material-symbols-outlined">fullscreen_exit</span>
        </button>
    </div>
</template>

<!-- Container für die vier Views -->
<div class="grid" id="viewContainer">
    <div id="view-insertion-point"></div>

    <div class="cell full-width">
        <div class="wrapper">
            <span class="pre-icon material-symbols-outlined">tv_displays</span>
            <label for="displaySelect">Monitor: </label>
            <select id="displaySelect" onchange="changeDisplay()">
                <option>Lade Monitore…</option>
            </select>
        </div>

        <div class="wrapper">
			<span class="pre-icon material-symbols-outlined">
				abc
			  </span>
            <label for="tickerText">Lauftext: </label>
            <input id="tickerText" onkeydown="submitTicker(event)" placeholder="Kein Lauftext"/>

            <input id="tickerColor" onchange="setTickerColor(event)" type="color" value="#ffffff"/>
            <input id="tickerBackgroundColor" onchange="setTickerBackgroundColor(event)" type="color" value="#111111"/>

            <button onclick="setTicker()">
                <span class="material-symbols-outlined">subdirectory_arrow_right</span>
            </button>
        </div>
    </div>
</div>

<div aria-label="Bildschirmquelle wählen" aria-modal="true" class="cap-modal cap-hidden" id="capModal" role="dialog">
    <div class="cap-box">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
            <h3 style="margin:0;font-size:16px">Quelle wählen</h3>

            <button class="cap-btn" id="capClose">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div aria-live="polite" class="cap-grid" id="capGrid"></div>
    </div>
</div>

<script>
    const viewConfigs = [
        {index: 0, label: "View 1 (oben links)", icon: "position_top_right", flip: true},
        {index: 1, label: "View 2 (oben rechts)", icon: "position_top_right"},
        {index: 2, label: "View 3 (unten links)", icon: "position_bottom_left"},
        {index: 3, label: "View 4 (unten rechts)", icon: "position_bottom_right"}
    ];

    const template = document.getElementById("control-template");
    const container = document.getElementById("viewContainer");
    const marker = document.getElementById("view-insertion-point");

    viewConfigs.forEach(({index, label, icon, flip}) => {
        const clone = template.content.cloneNode(true);
        const cell = clone.querySelector(".cell");
        const iconSpan = cell.querySelector(".icon");
        const preview = cell.querySelector(".preview-img");
        const backBtn = cell.querySelector(".backBtn");
        const forwardBtn = cell.querySelector(".forwardBtn");
        const input = cell.querySelector(".url");
        const navigateBtn = cell.querySelector(".navigateBtn");
        const fullscreenBtn = cell.querySelector(".fullscreenBtn");
        const priorityBtn = cell.querySelector(".priorityBtn");
        const screenShareBtn = cell.querySelector(".screenShareBtn");

        // Set dynamic content
        iconSpan.textContent = icon;
        if (flip) iconSpan.classList.add("flip-horizontal");

        preview.id = `preview${index}`;

        input.placeholder = label;
        input.id = `url${index}`;
        input.onkeydown = (e) => submitURL(e, index);

        backBtn.id = `backBtn${index}`;
        backBtn.onclick = () => goBack(index);

        forwardBtn.id = `forwardBtn${index}`;
        forwardBtn.onclick = () => goForward(index);

        navigateBtn.onclick = () => navigate(index);

        fullscreenBtn.id = `fullscreenBtn${index}`;
        fullscreenBtn.onclick = () => toggleFullscreen(index);

        priorityBtn.id = `priorityBtn${index}`;
        priorityBtn.onclick = () => togglePriority(index);

        screenShareBtn.id = `screenShareBtn${index}`;
        screenShareBtn.onclick = async () => {
            openCapturePicker(index, async (picked) => {
                await window.api.setDisplayCaptureSource(index, picked.id);
                await window.api.startDisplayCapture(index);
            });
        };

        container.insertBefore(clone, marker);
    });

    const inputs = [0, 1, 2, 3].map(i => document.getElementById(`url${i}`));
    const fullscreenBtns = [0, 1, 2, 3].map(i => document.getElementById(`fullscreenBtn${i}`));
    const priorityBtns = [0, 1, 2, 3].map(i => document.getElementById(`priorityBtn${i}`));
    const tickerInput = document.getElementById(`tickerText`);

    inputs.forEach(input => {
        let dragCounter = 0;

        input.addEventListener('dragenter', () => {
            dragCounter++;
            input.classList.add('drag-target');
        });

        input.addEventListener('dragleave', () => {
            dragCounter--;
            if (dragCounter === 0) {
                input.classList.remove('drag-target');
            }
        });

        input.addEventListener('drop', () => {
            dragCounter = 0;
            input.classList.remove('drag-target');
        });
    });

    window.api?.requestStoredURLs().then((stored) => {
        stored.forEach((url, i) => {
            if (inputs[i]) inputs[i].value = url;
        });
    });

    window.api?.onURLUpdate(({index, url, canGoBack, canGoForward}) => {
        const input = document.getElementById(`url${index}`);
        if (input) {
            input.value = url;
            saveAllURLs();
        }

        const backBtn = document.getElementById(`backBtn${index}`);
        const forwardBtn = document.getElementById(`forwardBtn${index}`);

        if (backBtn) backBtn.disabled = !canGoBack;
        if (forwardBtn) forwardBtn.disabled = !canGoForward;
    });

    function navigate(index) {
        const input = inputs[index];
        window.api?.navigate(index, input?.value || '');
        saveAllURLs();
    }

    function submitURL(event, index) {
        if (event.key === 'Enter') {
            navigate(index);
        }
    }

    function toggleFullscreen(index) {
        const active = fullscreenBtns[index].classList.contains('active');
        document.querySelectorAll('button.fullscreenBtn.active').forEach((btn) => {
            btn.classList.remove('active');
        });

        if (!active) {
            fullscreenBtns[index].classList.add('active');
        }

        window.api?.toggleFullscreen(index);
    }

    function togglePriority(index) {
        const active = priorityBtns[index].classList.contains('active');
        document.querySelectorAll('button.priorityBtn.active').forEach((btn) => {
            btn.classList.remove('active');
        });

        if (!active) {
            priorityBtns[index].classList.add('active');
        }

        window.api?.togglePriority(index);
    }

    function goBack(index) {
        window.api?.goBack(index);
    }

    function goForward(index) {
        window.api?.goForward(index);
    }

    function saveAllURLs() {
        const urls = inputs.map(input => input.value || '');
        window.api?.saveURLs(urls);
    }

    async function populateDisplayList() {
        const select = document.getElementById('displaySelect');
        const displays = await window.api?.getDisplays();

        select.innerHTML = ''; // leeren
        displays?.forEach(display => {
            const {index, bounds} = display;
            const option = document.createElement('option');
            option.value = index;
            option.text = `${index + 1}: ${bounds.width}×${bounds.height}`;
            select.appendChild(option);
        });
    }

    function changeDisplay() {
        const select = document.getElementById('displaySelect');
        const index = parseInt(select.value, 10);
        if (!isNaN(index)) {
            window.api?.moveToDisplay(index);
        }
    }

    populateDisplayList();

    function setTicker() {
        window.api?.setTickerText(tickerInput?.value || '');
    }

    function submitTicker(event) {
        if (event.key === 'Enter') {
            setTicker();
        }
    }

    function setTickerColor(event) {
        window.api?.setTickerColor(event.target.value);
    }

    function setTickerBackgroundColor(event) {
        window.api?.setTickerBackgroundColor(event.target.value);
    }

    window.api?.onDrop(({path, id}) => {
        if (id.startsWith('url')) {
            document.getElementById(id).value = path;
            const index = +id[3];
            window.api?.navigate(index, path);
            saveAllURLs();
        }
    });

    window.api?.loadTicker().then(({tickerText, tickerColor, tickerBackgroundColor}) => {
        if (tickerText) {
            tickerInput.value = tickerText;
            window.api?.setTickerText(tickerText);
        }

        if (tickerColor) {
            document.getElementById("tickerColor").value = tickerColor;
            window.api?.setTickerColor(tickerColor);
        }

        if (tickerBackgroundColor) {
            document.getElementById("tickerBackgroundColor").value = tickerBackgroundColor;
            window.api?.setTickerBackgroundColor(tickerBackgroundColor);
        }
    });

    function updatePreview(index) {
        window.api?.getScreenshot(index).then((dataUrl) => {
            if (dataUrl) {
                const img = document.getElementById(`preview${index}`);
                if (img) img.src = dataUrl;
            }
        });
    }

    setInterval(() => {
        for (let i = 0; i < 4; i++) {
            updatePreview(i);
        }
    }, 4000);

    const capModal = document.getElementById('capModal');
    const capGrid = document.getElementById('capGrid');
    const capClose = document.getElementById('capClose');

    function showCapModal(show) {
        capModal.classList.toggle('cap-hidden', !show);
        if (show) capModal.focus();
    }

    async function openCapturePicker(viewIndex, onPicked) {
        showCapModal(true);
        capGrid.innerHTML = '<div style="opacity:.7">Lade Quellen …</div>';
        try {
            const sources = await window.api.getCaptureSources();
            if (!sources?.length) {
                capGrid.innerHTML = '<div style="opacity:.7">Keine Quellen gefunden.</div>';
                return;
            }
            capGrid.innerHTML = '';
            for (const s of sources) {
                const card = document.createElement('button');
                card.type = 'button';
                card.className = 'cap-item';
                card.innerHTML = `
        <img class="cap-thumb" alt="" src="${s.thumbDataUrl || ''}">
        <div class="cap-name">${s.name || s.id}</div>
      `;
                if (s.id.startsWith('screen')) {
                    const iconEl = document.createElement('span');
                    iconEl.classList.add('material-symbols-outlined');
                    iconEl.innerHTML = 'monitor';
                    card.appendChild(iconEl);
                }

                card.onclick = async () => {
                    showCapModal(false);
                    onPicked?.(s);
                };
                capGrid.appendChild(card);
            }
        } catch (e) {
            capGrid.innerHTML = `<div style="color:#ff8">${e.message || e}</div>`;
        }
    }

    capClose.onclick = () => showCapModal(false);
</script>
</body>
</html>
